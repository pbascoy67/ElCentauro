<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa Lotes El Centauro</title>
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-fondo: #B3E5FC; /* Color celeste pastel */
            --color-primario: #4A90E2;
            --color-secundario: #50E3C2;
            --color-texto: #333333;
            --color-boton: #4A90E2;
            --color-boton-hover: #357ABD;
            --color-boton-actualizar: #FF5722;
            --color-boton-actualizar-hover: #E64A19;
            --color-boton-editar: #4CAF50;
            --color-boton-editar-hover: #388E3C;
            --color-lote-propietario: #A5D6A7; /* Verde suave */
            --color-lote-alquilada: #FFF59D; /* Amarillo suave */
            --color-lote-en-proceso: #FFCC80; /* Naranja suave */
            --color-lote-en-venta: #F44336; /* Rojo */
            --color-lote-en-alquiler: #2196F3; /* Azul */
            --color-lote-ambas: #9C27B0; /* Morado */
            --color-leyenda-fondo: #ffffff;
            --color-borde: #dddddd;
            --color-lote-seleccionado: #FFD700; /* Oro para resaltar lote seleccionado */
        }

        /* Estilos CSS */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--color-fondo);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            color: var(--color-texto);
        }

        h1, h3 {
            color: var(--color-texto);
            text-align: center;
        }

        .main-container {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            width: 100%;
        }

        .leyenda, .actualizar-datos, .configuracion-datos {
            padding: 15px;
            background-color: var(--color-leyenda-fondo);
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .leyenda h3, .actualizar-datos h3, .configuracion-datos h3 {
            margin-top: 0;
            font-weight: 500;
            text-align: center;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .leyenda-color, .leyenda-border {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #000;
            border-radius: 4px;
        }

        .leyenda-color {
            background-color: #fff;
        }

        .border-en-venta {
            border: 2px dashed var(--color-lote-en-venta);
        }

        .border-en-alquiler {
            border: 2px dashed var(--color-lote-en-alquiler);
        }

        .border-ambas {
            border: 2px dashed var(--color-lote-ambas);
        }

        .actualizar-datos button, .configuracion-datos button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #ffffff;
        }

        .btn-actualizar {
            background-color: var(--color-boton-actualizar);
        }

        .btn-actualizar:hover {
            background-color: var(--color-boton-actualizar-hover);
        }

        .btn-editar {
            background-color: var(--color-boton-editar);
        }

        .btn-editar:hover {
            background-color: var(--color-boton-editar-hover);
        }

        .button-save {
            margin-top: 10px;
            background-color: var(--color-boton);
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .button-save:hover {
            background-color: var(--color-boton-hover);
        }

        .mapa-container {
            overflow-x: auto;
            white-space: nowrap;
            background-color: var(--color-leyenda-fondo);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1 1 600px;
        }

        .mapa {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
        }

        .calle {
            display: grid;
            grid-template-columns: auto auto auto;
            justify-items: center;
            margin: 0.5cm;
            position: relative;
        }

        .calle-label {
            writing-mode: horizontal-tb;
            text-orientation: upright;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 16px;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-leyenda-fondo);
            padding: 2px 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .lado {
            display: flex;
            flex-direction: column;
        }

        .lado-izquierdo {
            justify-content: flex-end;
        }

        .lote {
            width: 70px;
            height: 50px;
            border: 1px solid var(--color-borde);
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            cursor: pointer;
            position: relative;
            border-radius: 4px;
            transition: transform 0.2s, box-shadow 0.2s, border 0.2s;
            user-select: none;
        }

        .lote:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .lote-seleccionado {
            border: 2px solid var(--color-lote-seleccionado);
        }

        .lote-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            border: none;
            text-align: center;
            width: 60px;
            font-weight: 500;
        }

        input[type="text"], 
        input[type="date"], 
        select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            font-family: 'Roboto', Arial, sans-serif;
        }

        .espacio-extra {
            height: 50px;
        }

        /* Estilos para estados y subestados */
        .estado-propietario {
            background-color: var(--color-lote-propietario);
            color: #ffffff;
        }

        .estado-alquilada {
            background-color: var(--color-lote-alquilada);
            color: #000000;
        }

        .estado-en-proceso {
            background-color: var(--color-lote-en-proceso);
            color: #ffffff;
        }

        .estado-en-venta {
            background-color: var(--color-lote-en-proceso);
            border: 2px solid var(--color-lote-en-venta);
        }

        .estado-en-alquiler {
            background-color: var(--color-lote-en-proceso);
            border: 2px solid var(--color-lote-en-alquiler);
        }

        .estado-ambas {
            background-color: var(--color-lote-en-proceso);
            border: 2px solid var(--color-lote-ambas);
        }

        .asterisco {
            color: red;
            font-weight: bold;
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 14px;
            pointer-events: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .calle {
                margin: 0.3cm;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }

            .sidebar {
                max-width: 100%;
            }

            .leyenda, .actualizar-datos, .configuracion-datos {
                padding: 10px;
                max-width: 100%;
            }

            .mapa-container {
                padding: 10px;
                flex: 1 1 100%;
            }

            .lote {
                width: 60px;
                height: 45px;
                margin-bottom: 6px;
            }

            .button-save {
                width: 100%;
                padding: 12px 0;
            }

            .calle-label {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .lote {
                width: 50px;
                height: 40px;
            }

            .calle {
                margin: 0.2cm;
            }

            .leyenda-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .leyenda-color, .leyenda-border {
                margin-bottom: 5px;
            }
        }

        /* Estilos para el formulario emergente y el overlay */
        #formularioLote {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>

<h1>Mapa Lotes El Centauro</h1>

<div class="main-container">
    <!-- Sidebar con Leyenda, Configuración de Datos y Actualización de Lotes -->
    <div class="sidebar">
        <!-- Sección de leyenda -->
        <div class="leyenda">
            <h3>Descripción de Estados</h3>
            <div class="leyenda-item">
                <div class="leyenda-color estado-propietario"></div>
                <span>Propietario</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-color estado-alquilada"></div>
                <span>Alquilada</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-color estado-en-proceso"></div>
                <span>En Proceso</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-en-venta"></div>
                <span>En venta</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-en-alquiler"></div>
                <span>En alquiler</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-ambas"></div>
                <span>Ambas</span>
            </div>
        </div>

        <!-- Sección Configuración de Lotes -->
        <div class="configuracion-datos">
            <h3>Configuración de Calles y Lotes</h3>
            <label for="cantidadCalles">Cantidad de Calles:</label>
            <input type="number" id="cantidadCalles" min="1" value="1">

            <!-- Llenar cada calle -->
            <div id="configuracionCalles"></div>

            <!-- Botón para guardar la configuración -->
            <button class="button-save" onclick="guardarConfiguracion()">
                <i class="fas fa-save"></i> Guardar Configuración
            </button>
        </div>

        <!-- Sección Actualizar Datos de Lotes -->
        <div class="actualizar-datos">
            <h3>Actualizar Datos de Lotes</h3>
            <label for="selectCalleEstado">Calle:</label>
            <select id="selectCalleEstado" onchange="actualizarOpcionesLotesEstado()">
                <option value="">Seleccione una calle</option>
                <!-- Opciones de calles generadas dinámicamente -->
            </select>
            <label for="selectLoteEstado">Lote:</label>
            <select id="selectLoteEstado">
                <option value="">Seleccione un lote</option>
                <!-- Opciones de lotes generadas dinámicamente -->
            </select>
            <label for="selectEstado">Estado:</label>
            <select id="selectEstado">
                <option value="">Seleccione un estado</option>
                <option value="propietario">Propietario</option>
                <option value="alquilada">Alquilada</option>
                <option value="en-proceso">En Proceso</option>
            </select>
            <button onclick="actualizarEstadoLote()" class="btn-actualizar">
                <i class="fas fa-sync-alt"></i> Actualizar Lote
            </button>
            <button onclick="mostrarFormularioDesdeEditar()" class="btn-editar">
                <i class="fas fa-edit"></i> Editar Lote
            </button>
        </div>
    </div>

    <!-- Contenedor del mapa -->
    <div class="mapa-container">
        <div class="mapa" id="mapa">
            <!-- Calles se generan dinámicamente aquí -->
        </div>
    </div>
</div>

<!-- Overlay para el formulario -->
<div id="overlay"></div>

<!-- Formulario emergente para editar datos del lote -->
<div id="formularioLote">
    <h3>Datos del Lote</h3>
    <label for="propietario">Nombre y Apellido del Propietario:</label>
    <input type="text" id="propietario" required>

    <label for="inquilino">Nombre y Apellido del Inquilino:</label>
    <input type="text" id="inquilino">

    <label for="fechaDesde">Fecha Contrato Desde:</label>
    <input type="date" id="fechaDesde">

    <label for="fechaHasta">Fecha Contrato Hasta:</label>
    <input type="date" id="fechaHasta">

    <label for="estado">Estado:</label>
    <select id="estado">
        <option value="">Seleccione un estado</option>
        <option value="propietario">Propietario</option>
        <option value="alquilada">Alquilada</option>
        <option value="en-proceso">En Proceso</option>
    </select>

    <!-- Subestado solo visible si el estado es "En Proceso" -->
    <div id="subestado-container" style="display: none; margin-top: 10px;">
        <label for="enProceso">En Proceso de:</label>
        <select id="enProceso">
            <option value="">Seleccione</option>
            <option value="en-venta">En Venta</option>
            <option value="en-alquiler">En Alquiler</option>
            <option value="ambas">Ambas</option>
        </select>
    </div>

    <!-- Campo para cargar archivos -->
    <label for="archivo">Adjuntar archivo:</label>
    <input type="file" id="archivo" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg">

    <!-- Previsualización de la imagen adjunta -->
    <img id="previsualizacionArchivo" src="#" alt="Previsualización" style="display: none; max-width: 100%; margin-top: 10px;">

    <!-- Enlace para ver o descargar el archivo adjunto -->
    <div id="archivoAdjunto" style="margin-top: 10px; display: none;">
        <a href="#" id="enlaceArchivo" target="_blank" download>
            <i class="fas fa-paperclip me-2"></i>Ver archivo adjunto
        </a>
        <button type="button" class="btn btn-danger btn-sm" onclick="borrarArchivoAdjunto()" id="botonBorrarArchivo" style="display: none;">
            <i class="fas fa-trash-alt me-2"></i>Borrar Archivo
        </button>
    </div>

    <button onclick="guardarDatosLote()" class="btn btn-primary" style="margin-top: 15px;">
        <i class="fas fa-save me-2"></i>Guardar
    </button>
    <button onclick="cerrarFormulario()" class="btn btn-secondary" style="margin-top: 15px;">
        <i class="fas fa-times me-2"></i>Cancelar
    </button>
</div>

<script>
    let lotesPorCalle = [];
    let loteActual = null; // Referencia al lote que se está editando

    // Función para cargar la configuración desde localStorage
    function cargarConfiguracion() {
        const configuracionGuardada = localStorage.getItem('lotesPorCalle');
        if (configuracionGuardada) {
            lotesPorCalle = JSON.parse(configuracionGuardada);
            generarLotes();
            poblarSelectCalleEstado();
            document.querySelector('.configuracion-datos').style.display = 'none';
            agregarBotonRestaurar();
        }
    }

    // Ejecutar al cargar la página
    window.onload = function() {
        cargarConfiguracion();
    };

    // Manejar el cambio en la cantidad de calles
    document.getElementById('cantidadCalles').addEventListener('change', function() {
        const configuracionCalles = document.getElementById('configuracionCalles');
        configuracionCalles.innerHTML = '';
        const cantidadCalles = parseInt(document.getElementById('cantidadCalles').value);

        for (let i = 1; i <= cantidadCalles; i++) {
            const calleConfig = document.createElement('div');
            calleConfig.className = 'calle-config';
            calleConfig.innerHTML = `
                <h4>Calle ${i}</h4>
                <label for="lotesLadoIzquierdo_${i}">Lotes por Lado Izquierdo:</label>
                <input type="number" id="lotesLadoIzquierdo_${i}" min="1" value="1">

                <label for="lotesLadoDerecho_${i}">Lotes por Lado Derecho:</label>
                <input type="number" id="lotesLadoDerecho_${i}" min="1" value="1">
            `;
            configuracionCalles.appendChild(calleConfig);
        }
    });

    // Función para guardar la configuración
    function guardarConfiguracion() {
        const cantidadCalles = parseInt(document.getElementById('cantidadCalles').value);
        lotesPorCalle = [];

        for (let i = 1; i <= cantidadCalles; i++) {
            const lotesIzquierdo = parseInt(document.getElementById(`lotesLadoIzquierdo_${i}`).value);
            const lotesDerecho = parseInt(document.getElementById(`lotesLadoDerecho_${i}`).value);

            let calle = {
                numero: i,
                lotesIzquierdo: [],
                lotesDerecho: []
            };

            // Generar lotes del lado izquierdo
            for (let j = 1; j <= lotesIzquierdo; j++) {
                calle.lotesIzquierdo.push({ numero: `L${j}`, estado: 'propietario' });
            }

            // Generar lotes del lado derecho
            for (let k = 1; k <= lotesDerecho; k++) {
                calle.lotesDerecho.push({ numero: `L${k}`, estado: 'propietario' });
            }

            lotesPorCalle.push(calle);
        }

        // Guardar en localStorage
        localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

        generarLotes();
        alert('Guardado exitoso.');
        document.querySelector('.configuracion-datos').style.display = 'none';
        agregarBotonRestaurar();
        poblarSelectCalleEstado();
    }

    // Función para generar el mapa de lotes basado en la configuración
    function generarLotes() {
        const mapa = document.getElementById('mapa');
        mapa.innerHTML = '';

        lotesPorCalle.forEach(calle => {
            const divCalle = document.createElement('div');
            divCalle.classList.add('calle');

            const ladoIzquierdo = document.createElement('div');
            ladoIzquierdo.classList.add('lado', 'lado-izquierdo');
            calle.lotesIzquierdo.forEach(lote => {
                const divLote = crearLoteElemento(calle.numero, lote);
                ladoIzquierdo.appendChild(divLote);
            });

            const ladoDerecho = document.createElement('div');
            ladoDerecho.classList.add('lado');
            calle.lotesDerecho.forEach(lote => {
                const divLote = crearLoteElemento(calle.numero, lote);
                ladoDerecho.appendChild(divLote);
            });

            const labelCalle = document.createElement('div');
            labelCalle.classList.add('calle-label');
            labelCalle.textContent = `Calle ${calle.numero}`;

            divCalle.appendChild(ladoIzquierdo);
            divCalle.appendChild(labelCalle);
            divCalle.appendChild(ladoDerecho);

            mapa.appendChild(divCalle);
        });
    }

    // Crear elemento de lote
    function crearLoteElemento(numeroCalle, lote) {
        const divLote = document.createElement('div');
        divLote.classList.add('lote');
        divLote.dataset.calle = numeroCalle;
        divLote.dataset.lote = lote.numero;
        divLote.dataset.estado = lote.estado;
        divLote.dataset.subestado = lote.subestado || '';

        // Aplicar clases de estado
        aplicarClaseEstado(divLote, lote.estado, lote.subestado);

        // Mostrar número de lote
        const inputLote = document.createElement('input');
        inputLote.type = 'text';
        inputLote.value = lote.numero;
        inputLote.placeholder = 'Lote';
        inputLote.className = 'lote-input';
        inputLote.onchange = (e) => {
            lote.numero = e.target.value;
            localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));
            generarLotes();
            poblarSelectCalleEstado();
        };

        divLote.appendChild(inputLote);

        // Manejar clic para selección
        divLote.addEventListener('click', function(event) {
            // Evitar que el clic en el input no seleccione el lote
            if (event.target.tagName.toLowerCase() !== 'input') {
                seleccionarLote(divLote);
            }
        });

        return divLote;
    }

    // Función para aplicar clases según el estado y subestado
    function aplicarClaseEstado(element, estado, subestado) {
        element.classList.remove('estado-propietario', 'estado-alquilada', 'estado-en-proceso',
                                 'estado-en-venta', 'estado-en-alquiler', 'estado-ambas');
        switch (estado) {
            case 'propietario':
                element.classList.add('estado-propietario');
                break;
            case 'alquilada':
                element.classList.add('estado-alquilada');
                break;
            case 'en-proceso':
                if (subestado === 'en-venta') {
                    element.classList.add('estado-en-venta');
                } else if (subestado === 'en-alquiler') {
                    element.classList.add('estado-en-alquiler');
                } else if (subestado === 'ambas') {
                    element.classList.add('estado-ambas');
                } else {
                    element.classList.add('estado-en-proceso');
                }
                break;
            default:
                break;
        }
    }

    // Función para seleccionar un lote
    function seleccionarLote(element) {
        // Remover selección anterior
        const lotes = document.querySelectorAll('.lote');
        lotes.forEach(lote => lote.classList.remove('lote-seleccionado'));

        // Seleccionar el lote actual
        element.classList.add('lote-seleccionado');
    }

    // Agregar botón para restaurar configuración
    function agregarBotonRestaurar() {
        // Verificar si el botón ya existe
        if (!document.getElementById('botonRestaurar')) {
            const botonRestaurar = document.createElement('button');
            botonRestaurar.classList.add('button-save');
            botonRestaurar.id = 'botonRestaurar';
            botonRestaurar.innerHTML = '<i class="fas fa-redo"></i> Restaurar Configuración';
            botonRestaurar.onclick = () => {
                if (confirm('¿Estás seguro de restaurar la configuración? Se perderán todos los datos actuales.')) {
                    lotesPorCalle = [];
                    localStorage.removeItem('lotesPorCalle');
                    document.getElementById('mapa').innerHTML = '';
                    document.getElementById('configuracionCalles').innerHTML = '';
                    document.querySelector('.configuracion-datos').style.display = 'block';
                    document.getElementById('cantidadCalles').value = 1;
                    document.querySelector('.sidebar').removeChild(botonRestaurar);
                    limpiarSelectActualizarDatos();
                }
            };

            document.querySelector('.sidebar').appendChild(botonRestaurar);
        }
    }

    // Limpiar selectores de la sección Actualizar Datos de Lotes
    function limpiarSelectActualizarDatos() {
        const selectCalle = document.getElementById('selectCalleEstado');
        const selectLote = document.getElementById('selectLoteEstado');
        const selectEstado = document.getElementById('selectEstado');
        selectCalle.innerHTML = '<option value="">Seleccione una calle</option>';
        selectLote.innerHTML = '<option value="">Seleccione un lote</option>';
        selectEstado.innerHTML = `
            <option value="">Seleccione un estado</option>
            <option value="propietario">Propietario</option>
            <option value="alquilada">Alquilada</option>
            <option value="en-proceso">En Proceso</option>
        `;
    }

    // Función para poblar el selector de calles en "Actualizar Datos de Lotes"
    function poblarSelectCalleEstado() {
        const selectCalle = document.getElementById('selectCalleEstado');
        selectCalle.innerHTML = '<option value="">Seleccione una calle</option>';

        lotesPorCalle.forEach(calle => {
            const option = document.createElement('option');
            option.value = calle.numero;
            option.textContent = `Calle ${calle.numero}`;
            selectCalle.appendChild(option);
        });
    }

    // Función para actualizar las opciones de lotes según la calle seleccionada
    function actualizarOpcionesLotesEstado() {
        const numeroCalle = document.getElementById('selectCalleEstado').value;
        const selectLote = document.getElementById('selectLoteEstado');
        selectLote.innerHTML = '<option value="">Seleccione un lote</option>';

        if (numeroCalle === "") return;

        const calle = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calle) return;

        const lotes = [...calle.lotesIzquierdo, ...calle.lotesDerecho];
        lotes.forEach(lote => {
            const option = document.createElement('option');
            option.value = lote.numero;
            option.textContent = lote.numero;
            selectLote.appendChild(option);
        });
    }

    // Función para actualizar el estado de un lote
    function actualizarEstadoLote() {
        const numeroCalle = document.getElementById('selectCalleEstado').value;
        const numeroLote = document.getElementById('selectLoteEstado').value;
        const estado = document.getElementById('selectEstado').value;

        if (numeroCalle === "" || numeroLote === "" || estado === "") {
            alert('Por favor, selecciona una calle, un lote y un estado.');
            return;
        }

        const calle = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calle) {
            alert('Calle no encontrada.');
            return;
        }

        // Buscar el lote en ambos lados
        let lote = calle.lotesIzquierdo.find(l => l.numero === numeroLote);
        let lado = 'izquierdo';
        if (!lote) {
            lote = calle.lotesDerecho.find(l => l.numero === numeroLote);
            lado = 'derecho';
        }

        if (!lote) {
            alert('Lote no encontrado.');
            return;
        }

        // Actualizar el estado principal
        lote.estado = estado;

        if (estado !== 'en-proceso') {
            // Si no es en-proceso, eliminar cualquier subestado previo
            lote.subestado = '';
        }

        // Aplicar la clase correspondiente
        const loteElem = loteElemento(lote, numeroCalle);
        aplicarClaseEstado(loteElem, lote.estado, lote.subestado);

        // Guardar en localStorage
        localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

        generarLotes();
        alert('Estado del lote actualizado exitosamente.');
    }

    // Función para obtener el elemento DOM del lote
    function loteElemento(lote, numeroCalle) {
        const lotes = document.querySelectorAll('.lote');
        for (let el of lotes) {
            if (el.dataset.calle == numeroCalle && el.dataset.lote == lote.numero) {
                return el;
            }
        }
        return null;
    }

    // Función para mostrar el formulario desde "Editar Lote"
    function mostrarFormularioDesdeEditar() {
        const numeroCalle = document.getElementById('selectCalleEstado').value;
        const numeroLote = document.getElementById('selectLoteEstado').value;

        if (numeroCalle === "" || numeroLote === "") {
            alert('Por favor, selecciona una calle y un lote para editar.');
            return;
        }

        // Buscar el lote en la configuración
        const calle = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calle) {
            alert('Calle no encontrada.');
            return;
        }

        let lote = calle.lotesIzquierdo.find(l => l.numero === numeroLote);
        let lado = 'izquierdo';
        if (!lote) {
            lote = calle.lotesDerecho.find(l => l.numero === numeroLote);
            lado = 'derecho';
        }

        if (!lote) {
            alert('Lote no encontrado.');
            return;
        }

        // Asignar el lote actual para editar
        loteActual = lote;

        // Mostrar el formulario
        document.getElementById('formularioLote').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';

        // Llenar los campos del formulario con los datos actuales
        document.getElementById('propietario').value = lote.propietario || '';
        document.getElementById('inquilino').value = lote.inquilino || '';
        document.getElementById('fechaDesde').value = lote.fechaDesde || '';
        document.getElementById('fechaHasta').value = lote.fechaHasta || '';
        document.getElementById('estado').value = lote.estado || '';
        document.getElementById('enProceso').value = lote.subestado || '';

        // Mostrar u ocultar el subestado según el estado principal
        if (lote.estado === 'en-proceso') {
            document.getElementById('subestado-container').style.display = 'block';
        } else {
            document.getElementById('subestado-container').style.display = 'none';
        }

        // Manejar archivos adjuntos si es necesario
        if (lote.archivo) {
            document.getElementById('enlaceArchivo').href = lote.archivo.url;
            document.getElementById('enlaceArchivo').textContent = lote.archivo.nombre;
            document.getElementById('archivoAdjunto').style.display = 'block';
            document.getElementById('botonBorrarArchivo').style.display = 'inline-block';
        } else {
            document.getElementById('archivoAdjunto').style.display = 'none';
            document.getElementById('previsualizacionArchivo').style.display = 'none';
            document.getElementById('botonBorrarArchivo').style.display = 'none';
        }
    }

    // Función para guardar los datos del lote desde el formulario
    function guardarDatosLote() {
        if (!loteActual) {
            alert('No se ha seleccionado ningún lote para editar.');
            return;
        }

        // Obtener los valores del formulario
        const propietario = document.getElementById('propietario').value.trim();
        const inquilino = document.getElementById('inquilino').value.trim();
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        const estado = document.getElementById('estado').value;
        const subestado = document.getElementById('enProceso').value;

        // Validaciones básicas
        if (estado === "") {
            alert('Por favor, selecciona un estado.');
            return;
        }

        if (estado === 'en-proceso' && subestado === "") {
            alert('Por favor, selecciona un subestado para "En Proceso".');
            return;
        }

        // Actualizar los datos del lote
        loteActual.propietario = propietario;
        loteActual.inquilino = inquilino;
        loteActual.fechaDesde = fechaDesde;
        loteActual.fechaHasta = fechaHasta;
        loteActual.estado = estado;
        loteActual.subestado = (estado === 'en-proceso') ? subestado : '';

        // Manejar archivo adjunto
        const archivoInput = document.getElementById('archivo');
        if (archivoInput.files.length > 0) {
            const archivo = archivoInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                loteActual.archivo = {
                    nombre: archivo.name,
                    url: e.target.result
                };
                document.getElementById('previsualizacionArchivo').src = e.target.result;
                document.getElementById('previsualizacionArchivo').style.display = 'block';
                document.getElementById('enlaceArchivo').href = e.target.result;
                document.getElementById('enlaceArchivo').textContent = archivo.name;
                document.getElementById('archivoAdjunto').style.display = 'block';
                document.getElementById('botonBorrarArchivo').style.display = 'inline-block';

                // Guardar en localStorage
                localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

                alert('Datos del lote guardados exitosamente.');
                cerrarFormulario();
                generarLotes();
                poblarSelectCalleEstado();
            };
            reader.readAsDataURL(archivo);
        } else {
            // Si no se ha adjuntado un archivo nuevo, mantener el existente
            localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

            alert('Datos del lote guardados exitosamente.');
            cerrarFormulario();
            generarLotes();
            poblarSelectCalleEstado();
        }
    }

    // Función para cerrar el formulario
    function cerrarFormulario() {
        document.getElementById('formularioLote').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        // Limpiar formulario
        document.getElementById('formularioLote').reset();
        document.getElementById('subestado-container').style.display = 'none';
        document.getElementById('previsualizacionArchivo').style.display = 'none';
        document.getElementById('archivoAdjunto').style.display = 'none';
        document.getElementById('botonBorrarArchivo').style.display = 'none';
        loteActual = null;
    }

    // Función para borrar el archivo adjunto
    function borrarArchivoAdjunto() {
        if (!loteActual) {
            alert('No se ha seleccionado ningún lote.');
            return;
        }

        loteActual.archivo = null;
        document.getElementById('archivoAdjunto').style.display = 'none';
        document.getElementById('previsualizacionArchivo').style.display = 'none';
        document.getElementById('archivo').value = '';
        document.getElementById('botonBorrarArchivo').style.display = 'none';

        // Guardar en localStorage
        localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

        alert('Archivo adjunto borrado.');
    }

    // Manejar la previsualización de archivos
    document.getElementById('archivo').addEventListener('change', function(event) {
        const archivo = event.target.files[0];
        if (archivo) {
            const previsualizacion = document.getElementById('previsualizacionArchivo');
            const archivoAdjunto = document.getElementById('archivoAdjunto');
            const enlaceArchivo = document.getElementById('enlaceArchivo');

            if (archivo.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previsualizacion.src = e.target.result;
                    previsualizacion.style.display = 'block';
                };
                reader.readAsDataURL(archivo);
            } else {
                previsualizacion.style.display = 'none';
            }

            // Crear un objeto URL para el archivo
            const urlArchivo = URL.createObjectURL(archivo);
            enlaceArchivo.href = urlArchivo;
            enlaceArchivo.textContent = archivo.name;
            archivoAdjunto.style.display = 'block';
            document.getElementById('botonBorrarArchivo').style.display = 'inline-block';
        }
    });

    // Escuchar cambios en el estado del formulario para mostrar u ocultar el subestado
    document.getElementById('estado').addEventListener('change', function() {
        const estado = this.value;
        if (estado === 'en-proceso') {
            document.getElementById('subestado-container').style.display = 'block';
        } else {
            document.getElementById('subestado-container').style.display = 'none';
            document.getElementById('enProceso').value = '';
        }
    });
</script>

</body>
</html>
