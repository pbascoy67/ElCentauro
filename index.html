<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa Lotes El Centauro - Mejorado</title>
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Panzoom CSS (No requiere CSS, pero se incluye para referencia) -->
    <style>
        :root {
            --color-fondo: #B3E5FC; /* Color celeste pastel */
            --color-primario: #4A90E2;
            --color-secundario: #50E3C2;
            --color-texto: #333333;
            --color-boton: #4A90E2;
            --color-boton-hover: #357ABD;
            --color-boton-actualizar: #FF5722;
            --color-boton-actualizar-hover: #E64A19;
            --color-boton-editar: #4CAF50;
            --color-boton-editar-hover: #388E3C;
            --color-lote-propietario: #A5D6A7; /* Verde suave */
            --color-lote-alquilada: #FFF59D; /* Amarillo suave */
            --color-lote-en-proceso: #FFCC80; /* Naranja suave */
            --color-lote-en-venta: #F44336; /* Rojo */
            --color-lote-en-alquiler: #2196F3; /* Azul */
            --color-lote-ambas: #9C27B0; /* Morado */
            --color-leyenda-fondo: #ffffff;
            --color-borde: #dddddd;
            --color-lote-seleccionado: #FFD700; /* Oro para resaltar lote seleccionado */
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --transition-duration: 0.3s;
        }

        /* Estilos CSS */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--color-fondo);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            color: var(--color-texto);
        }

        h1, h3 {
            color: var(--color-texto);
            text-align: center;
        }

        .main-container {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            width: 100%;
            transition: transform var(--transition-duration) ease;
        }

        .leyenda, .actualizar-datos, .configuracion-datos {
            padding: 20px;
            background-color: var(--color-leyenda-fondo);
            border-radius: 20px;
            box-shadow:
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
            transition: box-shadow var(--transition-duration) ease;
        }

        .leyenda:hover, .actualizar-datos:hover, .configuracion-datos:hover {
            box-shadow:
                4px 4px 8px var(--shadow-dark),
                -4px -4px 8px var(--shadow-light);
        }

        .leyenda h3, .actualizar-datos h3, .configuracion-datos h3 {
            margin-top: 0;
            font-weight: 500;
            text-align: center;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .leyenda-color, .leyenda-border {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            border-radius: 6px;
            box-shadow:
                inset 6px 6px 12px var(--shadow-dark),
                inset -6px -6px 12px var(--shadow-light);
        }

        .leyenda-color {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        .border-en-venta {
            border: 2px dashed var(--color-lote-en-venta);
        }

        .border-en-alquiler {
            border: 2px dashed var(--color-lote-en-alquiler);
        }

        .border-ambas {
            border: 2px dashed var(--color-lote-ambas);
        }

        .actualizar-datos button, .configuracion-datos button, .button-save {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease, transform var(--transition-duration) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #ffffff;
            box-shadow:
                6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
        }

        .actualizar-datos button:hover, .configuracion-datos button:hover, .button-save:hover {
            box-shadow:
                2px 2px 4px var(--shadow-dark),
                -2px -2px 4px var(--shadow-light);
            transform: translateY(-2px);
        }

        .btn-actualizar {
            background-color: var(--color-boton-actualizar);
        }

        .btn-actualizar:hover {
            background-color: var(--color-boton-actualizar-hover);
        }

        .btn-editar {
            background-color: var(--color-boton-editar);
        }

        .btn-editar:hover {
            background-color: var(--color-boton-editar-hover);
        }

        .button-save {
            background-color: var(--color-boton);
        }

        .button-save:hover {
            background-color: var(--color-boton-hover);
        }

        .mapa-container {
            overflow: hidden;
            background-color: var(--color-leyenda-fondo);
            padding: 30px;
            border-radius: 20px;
            box-shadow:
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
            flex: 1 1 600px;
            transition: box-shadow var(--transition-duration) ease;
            position: relative;
        }

        .mapa-container:hover {
            box-shadow:
                4px 4px 8px var(--shadow-dark),
                -4px -4px 8px var(--shadow-light);
        }

        .mapa {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            width: 100%;
            height: 100%;
            /* Initialize Panzoom */
            cursor: grab;
        }

        .calle {
            display: grid;
            grid-template-columns: auto auto auto;
            justify-items: center;
            margin: 0.5cm;
            position: relative;
            /* Añadir separación de 0.3 cm entre lados */
            column-gap: 0.3cm;
        }

        .calle-label {
            writing-mode: horizontal-tb;
            text-orientation: upright;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 16px;
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-leyenda-fondo);
            padding: 4px 10px;
            border-radius: 8px;
            box-shadow:
                4px 4px 8px var(--shadow-dark),
                -4px -4px 8px var(--shadow-light);
        }

        .lado {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .lado-izquierdo {
            justify-content: flex-end;
        }

        .lote {
            width: 80px;
            height: 60px;
            border-radius: 12px;
            background-color: var(--color-leyenda-fondo);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all var(--transition-duration) ease;
            box-shadow:
                6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
            user-select: none;
        }

        .lote:hover {
            box-shadow:
                2px 2px 4px var(--shadow-dark),
                -2px -2px 4px var(--shadow-light);
            transform: translateY(-4px);
        }

        .lote-seleccionado {
            border: 3px solid var(--color-lote-seleccionado);
            box-shadow:
                inset 4px 4px 8px var(--shadow-dark),
                inset -4px -4px 8px var(--shadow-light);
        }

        .lote-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            border: none;
            text-align: center;
            width: 60px;
            font-weight: 500;
            font-size: 1em;
            color: var(--color-texto);
            cursor: text;
        }

        .lote-input:focus {
            outline: none;
            border-bottom: 2px solid var(--color-primario);
        }

        input[type="text"], 
        input[type="date"], 
        select {
            width: 100%;
            padding: 12px 20px;
            box-sizing: border-box;
            border-radius: 12px;
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--color-leyenda-fondo);
            box-shadow:
                inset 6px 6px 12px var(--shadow-dark),
                inset -6px -6px 12px var(--shadow-light);
            border: none;
            transition: box-shadow var(--transition-duration) ease, border var(--transition-duration) ease;
            color: var(--color-texto);
        }

        input[type="text"]:focus, 
        input[type="date"]:focus, 
        select:focus {
            box-shadow:
                inset 2px 2px 4px var(--shadow-dark),
                inset -2px -2px 4px var(--shadow-light);
        }

        input:invalid {
            border: 2px solid red;
        }

        input:valid {
            border: 2px solid green;
        }

        .error-message {
            color: red;
            font-size: 0.8em;
            display: none;
        }

        input:invalid + .error-message {
            display: block;
        }

        .espacio-extra {
            height: 50px;
        }

        /* Estilos para estados y subestados */
        .estado-propietario {
            background-color: var(--color-lote-propietario);
            color: #ffffff;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .estado-alquilada {
            background-color: var(--color-lote-alquilada);
            color: #000000;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .estado-en-proceso {
            background-color: var(--color-lote-en-proceso);
            color: #ffffff;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .estado-en-venta,
        .estado-en-alquiler,
        .estado-ambas {
            background-color: var(--color-lote-en-proceso);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .estado-en-venta {
            border: 2px dashed var(--color-lote-en-venta);
            color: #ffffff;
        }

        .estado-en-alquiler {
            border: 2px dashed var(--color-lote-en-alquiler);
            color: #ffffff;
        }

        .estado-ambas {
            border: 2px dashed var(--color-lote-ambas);
            color: #ffffff;
        }

        .asterisco {
            color: red;
            font-weight: bold;
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 14px;
            pointer-events: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .calle {
                margin: 0.3cm;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }

            .sidebar {
                max-width: 100%;
            }

            .leyenda, .actualizar-datos, .configuracion-datos {
                padding: 15px;
                max-width: 100%;
            }

            .mapa-container {
                padding: 15px;
                flex: 1 1 100%;
            }

            .lote {
                width: 70px;
                height: 50px;
                margin-bottom: 6px;
            }

            .button-save {
                width: 100%;
                padding: 12px 0;
            }

            .calle-label {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .lote {
                width: 60px;
                height: 45px;
            }

            .calle {
                margin: 0.2cm;
            }

            .leyenda-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .leyenda-color, .leyenda-border {
                margin-bottom: 5px;
            }
        }

        /* Estilos para el formulario emergente y el overlay */
        #formularioLote {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-leyenda-fondo);
            padding: 30px;
            border-radius: 20px;
            box-shadow:
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            transition: box-shadow var(--transition-duration) ease;
        }

        #formularioLote:hover {
            box-shadow:
                4px 4px 8px var(--shadow-dark),
                -4px -4px 8px var(--shadow-light);
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 999;
        }

        /* Botones dentro del formulario */
        #formularioLote button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #ffffff;
            margin-top: 15px;
            box-shadow:
                6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
        }

        #formularioLote button:hover {
            box-shadow:
                2px 2px 4px var(--shadow-dark),
                -2px -2px 4px var(--shadow-light);
            transform: translateY(-2px);
        }

        #formularioLote .btn-primary {
            background-color: var(--color-boton);
        }

        #formularioLote .btn-primary:hover {
            background-color: var(--color-boton-hover);
        }

        #formularioLote .btn-secondary {
            background-color: #757575;
        }

        #formularioLote .btn-secondary:hover {
            background-color: #5c5c5c;
        }

        /* Estilos para área de arrastrar y soltar */
        .dropzone {
            border: 2px dashed var(--color-borde);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color var(--transition-duration) ease;
            margin-top: 10px;
        }

        .dropzone.dragover {
            background-color: var(--color-lote-en-proceso);
        }

        /* Previsualización de imágenes */
        #previsualizacionArchivo {
            display: none;
            max-width: 100%;
            margin-top: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<h1>Mapa Lotes El Centauro</h1>

<div class="main-container">
    <!-- Sidebar con Leyenda, Configuración de Datos y Actualización de Lotes -->
    <div class="sidebar">
        <!-- Sección de leyenda -->
        <div class="leyenda">
            <h3>Descripción de Estados</h3>
            <div class="leyenda-item">
                <div class="leyenda-color estado-propietario"></div>
                <span>Propietario</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-color estado-alquilada"></div>
                <span>Alquilada</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-color estado-en-proceso"></div>
                <span>En Proceso</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-en-venta"></div>
                <span>En venta</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-en-alquiler"></div>
                <span>En alquiler</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-border border-ambas"></div>
                <span>Ambas</span>
            </div>
        </div>

        <!-- Sección Configuración de Lotes -->
        <div class="configuracion-datos">
            <h3>Configuración de Calles y Lotes</h3>
            <label for="cantidadCalles">Cantidad de Calles:</label>
            <input type="number" id="cantidadCalles" min="1" value="1">

            <!-- Llenar cada calle -->
            <div id="configuracionCalles"></div>

            <!-- Botón para guardar la configuración -->
            <button class="button-save" onclick="guardarConfiguracion()">
                <i class="fas fa-save"></i> Guardar Configuración
            </button>
        </div>

        <!-- Sección Actualizar Datos de Lotes -->
        <div class="actualizar-datos">
            <h3>Actualizar Datos de Lotes</h3>
            <label for="selectCalleEstado">Calle:</label>
            <select id="selectCalleEstado" onchange="actualizarOpcionesLotesEstado()">
                <option value="">Seleccione una calle</option>
                <!-- Opciones de calles generadas dinámicamente -->
            </select>
            <label for="selectLoteEstado">Lote:</label>
            <select id="selectLoteEstado">
                <option value="">Seleccione un lote</option>
                <!-- Opciones de lotes generadas dinámicamente -->
            </select>
            <label for="selectEstado">Estado:</label>
            <select id="selectEstado">
                <option value="">Seleccione un estado</option>
                <option value="propietario">Propietario</option>
                <option value="alquilada">Alquilada</option>
                <option value="en-proceso">En Proceso</option>
            </select>
            <button onclick="actualizarEstadoLote()" class="btn-actualizar">
                <i class="fas fa-sync-alt"></i> Actualizar Lote
            </button>
            <button onclick="editarLoteDesdeSeleccion()" class="btn-editar">
                <i class="fas fa-edit"></i> Editar Lote
            </button>
        </div>
    </div>

    <!-- Contenedor del mapa -->
    <div class="mapa-container">
        <div class="mapa" id="mapa">
            <!-- Calles se generan dinámicamente aquí -->
        </div>
    </div>
</div>

<!-- Overlay para el formulario -->
<div id="overlay"></div>

<!-- Formulario emergente para editar datos del lote -->
<div id="formularioLote">
    <h3>Datos del Lote</h3>
    <form id="formLote">
        <label for="propietario">Nombre y Apellido del Propietario: <span class="asterisco">*</span></label>
        <input type="text" id="propietario" required>
        <span class="error-message">Este campo es obligatorio.</span>

        <label for="inquilino">Nombre y Apellido del Inquilino:</label>
        <input type="text" id="inquilino">

        <label for="fechaDesde">Fecha Contrato Desde:</label>
        <input type="date" id="fechaDesde">

        <label for="fechaHasta">Fecha Contrato Hasta:</label>
        <input type="date" id="fechaHasta">

        <label for="estado">Estado: <span class="asterisco">*</span></label>
        <select id="estado" required>
            <option value="">Seleccione un estado</option>
            <option value="propietario">Propietario</option>
            <option value="alquilada">Alquilada</option>
            <option value="en-proceso">En Proceso</option>
        </select>
        <span class="error-message">Este campo es obligatorio.</span>

        <!-- Subestado solo visible si el estado es "En Proceso" -->
        <div id="subestado-container" style="display: none; margin-top: 10px;">
            <label for="enProceso">En Proceso de: <span class="asterisco">*</span></label>
            <select id="enProceso" required>
                <option value="">Seleccione</option>
                <option value="en-venta">En Venta</option>
                <option value="en-alquiler">En Alquiler</option>
                <option value="ambas">Ambas</option>
            </select>
            <span class="error-message">Este campo es obligatorio.</span>
        </div>

        <!-- Campo para cargar archivos -->
        <label for="archivo">Adjuntar archivo:</label>
        <div class="dropzone" id="dropzone">
            <i class="fas fa-upload"></i> Arrastra y suelta un archivo aquí o haz clic para seleccionar.
            <input type="file" id="archivo" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" style="display: none;">
        </div>

        <!-- Previsualización de la imagen adjunta -->
        <img id="previsualizacionArchivo" src="#" alt="Previsualización">

        <!-- Enlace para ver o descargar el archivo adjunto -->
        <div id="archivoAdjunto" style="margin-top: 10px; display: none;">
            <a href="#" id="enlaceArchivo" target="_blank" download>
                <i class="fas fa-paperclip me-2"></i>Ver archivo adjunto
            </a>
            <button type="button" class="btn btn-danger btn-sm" onclick="borrarArchivoAdjunto()" id="botonBorrarArchivo" style="display: none;">
                <i class="fas fa-trash-alt me-2"></i>Borrar Archivo
            </button>
        </div>

        <button type="submit" class="btn-primary">
            <i class="fas fa-save me-2"></i>Guardar
        </button>
        <button type="button" onclick="cerrarFormulario()" class="btn-secondary">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
    </form>
</div>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Panzoom JS -->
<script src="https://unpkg.com/@panzoom/panzoom@4.4.0/dist/panzoom.min.js"></script>
<script>
    let lotesPorCalle = [];
    let loteActual = null; // Referencia al lote que se está editando
    let panzoomInstance = null;

    // Función para cargar la configuración desde localStorage
    function cargarConfiguracion() {
        const configuracionGuardada = localStorage.getItem('lotesPorCalle');
        if (configuracionGuardada) {
            lotesPorCalle = JSON.parse(configuracionGuardada);
            generarLotes();
            poblarSelectCalleEstado();
            document.querySelector('.configuracion-datos').style.display = 'none';
            agregarBotonRestaurar();
        }
    }

    // Ejecutar al cargar la página
    window.onload = function() {
        cargarConfiguracion();
        inicializarPanzoom();
        inicializarDragAndDrop();
        inicializarValidacionesFormulario();
    };

    // Inicializar Panzoom
    function inicializarPanzoom() {
        const mapaContainer = document.querySelector('.mapa-container');
        panzoomInstance = Panzoom(mapaContainer.querySelector('.mapa'), {
            maxScale: 5,
            minScale: 0.5,
            contain: 'outside'
        });

        // Añadir eventos de zoom y pan a la rueda del ratón
        mapaContainer.addEventListener('wheel', panzoomInstance.zoomWithWheel);
    }

    // Manejar el cambio en la cantidad de calles
    document.getElementById('cantidadCalles').addEventListener('change', function() {
        const configuracionCalles = document.getElementById('configuracionCalles');
        configuracionCalles.innerHTML = '';
        const cantidadCalles = parseInt(document.getElementById('cantidadCalles').value);

        for (let i = 1; i <= cantidadCalles; i++) {
            const calleConfig = document.createElement('div');
            calleConfig.className = 'calle-config';
            calleConfig.innerHTML = `
                <h4>Calle ${i}</h4>
                <label for="lotesLadoIzquierdo_${i}">Lotes por Lado Izquierdo:</label>
                <input type="number" id="lotesLadoIzquierdo_${i}" min="1" value="1">

                <label for="lotesLadoDerecho_${i}">Lotes por Lado Derecho:</label>
                <input type="number" id="lotesLadoDerecho_${i}" min="1" value="1">
            `;
            configuracionCalles.appendChild(calleConfig);
        }
    });

    // Función para guardar la configuración
    function guardarConfiguracion() {
        const cantidadCalles = parseInt(document.getElementById('cantidadCalles').value);
        if (cantidadCalles < 1) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'La cantidad de calles debe ser al menos 1.'
            });
            return;
        }

        lotesPorCalle = [];

        for (let i = 1; i <= cantidadCalles; i++) {
            const lotesIzquierdo = parseInt(document.getElementById(`lotesLadoIzquierdo_${i}`).value);
            const lotesDerecho = parseInt(document.getElementById(`lotesLadoDerecho_${i}`).value);

            if (lotesIzquierdo < 1 || lotesDerecho < 1) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'La cantidad de lotes por lado debe ser al menos 1.'
                });
                return;
            }

            let calle = {
                numero: i,
                lotesIzquierdo: [],
                lotesDerecho: []
            };

            // Generar lotes del lado izquierdo
            for (let j = 1; j <= lotesIzquierdo; j++) {
                calle.lotesIzquierdo.push({ numero: `L${j}`, estado: 'propietario' });
            }

            // Generar lotes del lado derecho
            for (let k = 1; k <= lotesDerecho; k++) {
                calle.lotesDerecho.push({ numero: `L${k}`, estado: 'propietario' });
            }

            lotesPorCalle.push(calle);
        }

        // Guardar en localStorage
        localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

        generarLotes();
        Swal.fire({
            icon: 'success',
            title: 'Guardado Exitoso',
            text: 'La configuración se ha guardado correctamente.'
        });
        document.querySelector('.configuracion-datos').style.display = 'none';
        agregarBotonRestaurar();
        poblarSelectCalleEstado();
    }

    // Función para generar el mapa de lotes basado en la configuración
    function generarLotes() {
        const mapa = document.getElementById('mapa');
        mapa.innerHTML = '';

        lotesPorCalle.forEach(calle => {
            const divCalle = document.createElement('div');
            divCalle.classList.add('calle');

            const ladoIzquierdo = document.createElement('div');
            ladoIzquierdo.classList.add('lado', 'lado-izquierdo');
            calle.lotesIzquierdo.forEach(lote => {
                const divLote = crearLoteElemento(calle.numero, lote);
                ladoIzquierdo.appendChild(divLote);
            });

            const ladoDerecho = document.createElement('div');
            ladoDerecho.classList.add('lado');
            calle.lotesDerecho.forEach(lote => {
                const divLote = crearLoteElemento(calle.numero, lote);
                ladoDerecho.appendChild(divLote);
            });

            const labelCalle = document.createElement('div');
            labelCalle.classList.add('calle-label');
            labelCalle.textContent = `Calle ${calle.numero}`;

            divCalle.appendChild(ladoIzquierdo);
            divCalle.appendChild(labelCalle);
            divCalle.appendChild(ladoDerecho);

            mapa.appendChild(divCalle);
        });
    }

    // Crear elemento de lote
    function crearLoteElemento(numeroCalle, lote) {
        const divLote = document.createElement('div');
        divLote.classList.add('lote');
        divLote.dataset.calle = numeroCalle;
        divLote.dataset.lote = lote.numero;
        divLote.dataset.estado = lote.estado;
        divLote.dataset.subestado = lote.subestado || '';

        // Aplicar clases de estado
        aplicarClaseEstado(divLote, lote.estado, lote.subestado);

        // Mostrar número de lote
        const inputLote = document.createElement('input');
        inputLote.type = 'text';
        inputLote.value = lote.numero;
        inputLote.placeholder = 'Lote';
        inputLote.className = 'lote-input';
        inputLote.setAttribute('readonly', 'readonly'); // Inicialmente readonly

        // Event Listener para hacer editable al hacer clic
        inputLote.addEventListener('click', function(e) {
            e.stopPropagation(); // Evitar que el evento se propague al lote
            inputLote.removeAttribute('readonly');
            inputLote.focus();
        });

        // Guardar el nuevo número al presionar Enter o al perder el foco
        inputLote.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                inputLote.blur();
            }
        });

        inputLote.addEventListener('blur', function() {
            inputLote.setAttribute('readonly', 'readonly');
            lote.numero = inputLote.value.trim() === '' ? lote.numero : inputLote.value.trim();
            divLote.dataset.lote = lote.numero;
            localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));
            generarLotes();
            poblarSelectCalleEstado();
        });

        divLote.appendChild(inputLote);

        // Manejar doble clic para mostrar información detallada
        divLote.addEventListener('dblclick', function(event) {
            // Evitar que el doble clic en el input no muestre el popup
            if (event.target.tagName.toLowerCase() !== 'input') {
                mostrarFormularioDesdeMapa(divLote.dataset, divLote.dataset.calle);
            }
        });

        return divLote;
    }

    // Función para aplicar clases según el estado y subestado
    function aplicarClaseEstado(element, estado, subestado) {
        element.classList.remove('estado-propietario', 'estado-alquilada', 'estado-en-proceso',
                                 'estado-en-venta', 'estado-en-alquiler', 'estado-ambas');
        switch (estado) {
            case 'propietario':
                element.classList.add('estado-propietario');
                break;
            case 'alquilada':
                element.classList.add('estado-alquilada');
                break;
            case 'en-proceso':
                if (subestado === 'en-venta') {
                    element.classList.add('estado-en-venta');
                } else if (subestado === 'en-alquiler') {
                    element.classList.add('estado-en-alquiler');
                } else if (subestado === 'ambas') {
                    element.classList.add('estado-ambas');
                } else {
                    element.classList.add('estado-en-proceso');
                }
                break;
            default:
                break;
        }
    }

    // Función para seleccionar un lote
    function seleccionarLote(element) {
        // Remover selección anterior
        const lotes = document.querySelectorAll('.lote');
        lotes.forEach(lote => lote.classList.remove('lote-seleccionado'));

        // Seleccionar el lote actual
        element.classList.add('lote-seleccionado');
    }

    // Agregar botón para restaurar configuración
    function agregarBotonRestaurar() {
        // Verificar si el botón ya existe
        if (!document.getElementById('botonRestaurar')) {
            const botonRestaurar = document.createElement('button');
            botonRestaurar.classList.add('button-save');
            botonRestaurar.id = 'botonRestaurar';
            botonRestaurar.innerHTML = '<i class="fas fa-redo"></i> Restaurar Configuración';
            botonRestaurar.onclick = () => {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Se perderán todos los datos actuales.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, restaurar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        lotesPorCalle = [];
                        localStorage.removeItem('lotesPorCalle');
                        document.getElementById('mapa').innerHTML = '';
                        document.getElementById('configuracionCalles').innerHTML = '';
                        document.querySelector('.configuracion-datos').style.display = 'block';
                        document.getElementById('cantidadCalles').value = 1;
                        document.querySelector('.sidebar').removeChild(botonRestaurar);
                        limpiarSelectActualizarDatos();
                        Swal.fire(
                            'Restaurado',
                            'La configuración ha sido restaurada.',
                            'success'
                        );
                    }
                });
            };

            document.querySelector('.sidebar').appendChild(botonRestaurar);
        }
    }

    // Limpiar selectores de la sección Actualizar Datos de Lotes
    function limpiarSelectActualizarDatos() {
        const selectCalle = document.getElementById('selectCalleEstado');
        const selectLote = document.getElementById('selectLoteEstado');
        const selectEstado = document.getElementById('selectEstado');
        selectCalle.innerHTML = '<option value="">Seleccione una calle</option>';
        selectLote.innerHTML = '<option value="">Seleccione un lote</option>';
        selectEstado.innerHTML = `
            <option value="">Seleccione un estado</option>
            <option value="propietario">Propietario</option>
            <option value="alquilada">Alquilada</option>
            <option value="en-proceso">En Proceso</option>
        `;
    }

    // Función para poblar el selector de calles en "Actualizar Datos de Lotes"
    function poblarSelectCalleEstado() {
        const selectCalle = document.getElementById('selectCalleEstado');
        selectCalle.innerHTML = '<option value="">Seleccione una calle</option>';

        lotesPorCalle.forEach(calle => {
            const option = document.createElement('option');
            option.value = calle.numero;
            option.textContent = `Calle ${calle.numero}`;
            selectCalle.appendChild(option);
        });
    }

    // Función para actualizar las opciones de lotes según la calle seleccionada
    function actualizarOpcionesLotesEstado() {
        const numeroCalle = document.getElementById('selectCalleEstado').value;
        const selectLote = document.getElementById('selectLoteEstado');
        selectLote.innerHTML = '<option value="">Seleccione un lote</option>';

        if (numeroCalle === "") return;

        const calle = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calle) return;

        const lotes = [...calle.lotesIzquierdo, ...calle.lotesDerecho];
        lotes.forEach(lote => {
            const option = document.createElement('option');
            option.value = lote.numero;
            option.textContent = lote.numero;
            selectLote.appendChild(option);
        });
    }

    // Función para actualizar el estado de un lote
    function actualizarEstadoLote() {
        const numeroCalle = document.getElementById('selectCalleEstado').value;
        const numeroLote = document.getElementById('selectLoteEstado').value;
        const estado = document.getElementById('selectEstado').value;

        if (numeroCalle === "" || numeroLote === "" || estado === "") {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor, selecciona una calle, un lote y un estado.'
            });
            return;
        }

        const calle = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calle) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Calle no encontrada.'
            });
            return;
        }

        // Buscar el lote en ambos lados
        let lote = calle.lotesIzquierdo.find(l => l.numero === numeroLote);
        let lado = 'izquierdo';
        if (!lote) {
            lote = calle.lotesDerecho.find(l => l.numero === numeroLote);
            lado = 'derecho';
        }

        if (!lote) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Lote no encontrado.'
            });
            return;
        }

        // Actualizar el estado principal
        lote.estado = estado;

        if (estado !== 'en-proceso') {
            // Si no es en-proceso, eliminar cualquier subestado previo
            lote.subestado = '';
        }

        // Aplicar la clase correspondiente
        const loteElem = loteElemento(lote, numeroCalle);
        if (loteElem) {
            aplicarClaseEstado(loteElem, lote.estado, lote.subestado);
        }

        // Guardar en localStorage
        localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

        generarLotes();
        Swal.fire({
            icon: 'success',
            title: 'Actualizado',
            text: 'Estado del lote actualizado exitosamente.'
        });
    }

    // Función para obtener el elemento DOM del lote
    function loteElemento(lote, numeroCalle) {
        const lotes = document.querySelectorAll('.lote');
        for (let el of lotes) {
            if (el.dataset.calle == numeroCalle && el.dataset.lote == lote.numero) {
                return el;
            }
        }
        return null;
    }

    // Función para editar lote desde la selección en los dropdowns
    function editarLoteDesdeSeleccion() {
        const numeroCalle = document.getElementById('selectCalleEstado').value;
        const numeroLote = document.getElementById('selectLoteEstado').value;

        if (numeroCalle === "" || numeroLote === "") {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor, selecciona una calle y un lote para editar.'
            });
            return;
        }

        const calle = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calle) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Calle no encontrada.'
            });
            return;
        }

        let lote = calle.lotesIzquierdo.find(l => l.numero === numeroLote);
        let lado = 'izquierdo';
        if (!lote) {
            lote = calle.lotesDerecho.find(l => l.numero === numeroLote);
            lado = 'derecho';
        }

        if (!lote) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Lote no encontrado.'
            });
            return;
        }

        // Asignar el lote actual para editar
        loteActual = lote;

        // Mostrar el formulario
        document.getElementById('formularioLote').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';

        // Llenar los campos del formulario con los datos actuales
        document.getElementById('propietario').value = lote.propietario || '';
        document.getElementById('inquilino').value = lote.inquilino || '';
        document.getElementById('fechaDesde').value = lote.fechaDesde || '';
        document.getElementById('fechaHasta').value = lote.fechaHasta || '';
        document.getElementById('estado').value = lote.estado || '';
        document.getElementById('enProceso').value = lote.subestado || '';

        // Mostrar u ocultar el subestado según el estado principal
        if (lote.estado === 'en-proceso') {
            document.getElementById('subestado-container').style.display = 'block';
            document.getElementById('enProceso').required = true;
        } else {
            document.getElementById('subestado-container').style.display = 'none';
            document.getElementById('enProceso').value = '';
            document.getElementById('enProceso').required = false;
        }

        // Manejar archivos adjuntos si es necesario
        if (lote.archivo) {
            document.getElementById('enlaceArchivo').href = lote.archivo.url;
            document.getElementById('enlaceArchivo').textContent = lote.archivo.nombre;
            document.getElementById('archivoAdjunto').style.display = 'block';
            document.getElementById('botonBorrarArchivo').style.display = 'inline-block';
        } else {
            document.getElementById('archivoAdjunto').style.display = 'none';
            document.getElementById('previsualizacionArchivo').style.display = 'none';
            document.getElementById('botonBorrarArchivo').style.display = 'none';
        }
    }

    // Función para mostrar el formulario desde el mapa al hacer doble clic
    function mostrarFormularioDesdeMapa(data, numeroCalle) {
        // Buscar el lote en la configuración
        const calleObj = lotesPorCalle.find(c => c.numero == numeroCalle);
        if (!calleObj) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Calle no encontrada.'
            });
            return;
        }

        let loteObj = calleObj.lotesIzquierdo.find(l => l.numero === data.lote);
        if (!loteObj) {
            loteObj = calleObj.lotesDerecho.find(l => l.numero === data.lote);
        }

        if (!loteObj) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Lote no encontrado.'
            });
            return;
        }

        // Asignar el lote actual para editar
        loteActual = loteObj;

        // Mostrar el formulario
        document.getElementById('formularioLote').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';

        // Llenar los campos del formulario con los datos actuales
        document.getElementById('propietario').value = loteObj.propietario || '';
        document.getElementById('inquilino').value = loteObj.inquilino || '';
        document.getElementById('fechaDesde').value = loteObj.fechaDesde || '';
        document.getElementById('fechaHasta').value = loteObj.fechaHasta || '';
        document.getElementById('estado').value = loteObj.estado || '';
        document.getElementById('enProceso').value = loteObj.subestado || '';

        // Mostrar u ocultar el subestado según el estado principal
        if (loteObj.estado === 'en-proceso') {
            document.getElementById('subestado-container').style.display = 'block';
            document.getElementById('enProceso').required = true;
        } else {
            document.getElementById('subestado-container').style.display = 'none';
            document.getElementById('enProceso').value = '';
            document.getElementById('enProceso').required = false;
        }

        // Manejar archivos adjuntos si es necesario
        if (loteObj.archivo) {
            document.getElementById('enlaceArchivo').href = loteObj.archivo.url;
            document.getElementById('enlaceArchivo').textContent = loteObj.archivo.nombre;
            document.getElementById('archivoAdjunto').style.display = 'block';
            document.getElementById('botonBorrarArchivo').style.display = 'inline-block';
        } else {
            document.getElementById('archivoAdjunto').style.display = 'none';
            document.getElementById('previsualizacionArchivo').style.display = 'none';
            document.getElementById('botonBorrarArchivo').style.display = 'none';
        }
    }

    // Función para guardar los datos del lote desde el formulario
    function guardarDatosLote(event) {
        event.preventDefault();

        if (!loteActual) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se ha seleccionado ningún lote para editar.'
            });
            return;
        }

        // Obtener los valores del formulario
        const propietario = document.getElementById('propietario').value.trim();
        const inquilino = document.getElementById('inquilino').value.trim();
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        const estado = document.getElementById('estado').value;
        const subestado = document.getElementById('enProceso').value;

        // Validaciones básicas
        if (propietario === '') {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'El campo "Propietario" es obligatorio.'
            });
            return;
        }

        if (estado === "") {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor, selecciona un estado.'
            });
            return;
        }

        if (estado === 'en-proceso' && subestado === "") {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor, selecciona un subestado para "En Proceso".'
            });
            return;
        }

        // Actualizar los datos del lote
        loteActual.propietario = propietario;
        loteActual.inquilino = inquilino;
        loteActual.fechaDesde = fechaDesde;
        loteActual.fechaHasta = fechaHasta;
        loteActual.estado = estado;
        loteActual.subestado = (estado === 'en-proceso') ? subestado : '';

        // Manejar archivo adjunto
        const archivoInput = document.getElementById('archivo');
        if (archivoInput.files.length > 0) {
            const archivo = archivoInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                loteActual.archivo = {
                    nombre: archivo.name,
                    url: e.target.result
                };
                document.getElementById('previsualizacionArchivo').src = e.target.result;
                document.getElementById('previsualizacionArchivo').style.display = 'block';
                document.getElementById('enlaceArchivo').href = e.target.result;
                document.getElementById('enlaceArchivo').textContent = archivo.name;
                document.getElementById('archivoAdjunto').style.display = 'block';
                document.getElementById('botonBorrarArchivo').style.display = 'inline-block';

                // Guardar en localStorage
                localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

                Swal.fire({
                    icon: 'success',
                    title: 'Guardado',
                    text: 'Datos del lote guardados exitosamente.'
                });
                cerrarFormulario();
                generarLotes();
                poblarSelectCalleEstado();
            };
            reader.readAsDataURL(archivo);
        } else {
            // Si no se ha adjuntado un archivo nuevo, mantener el existente
            localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

            Swal.fire({
                icon: 'success',
                title: 'Guardado',
                text: 'Datos del lote guardados exitosamente.'
            });
            cerrarFormulario();
            generarLotes();
            poblarSelectCalleEstado();
        }
    }

    // Función para cerrar el formulario
    function cerrarFormulario() {
        document.getElementById('formularioLote').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        // Limpiar formulario
        document.getElementById('formLote').reset();
        document.getElementById('subestado-container').style.display = 'none';
        document.getElementById('previsualizacionArchivo').style.display = 'none';
        document.getElementById('archivoAdjunto').style.display = 'none';
        document.getElementById('botonBorrarArchivo').style.display = 'none';
        loteActual = null;
    }

    // Función para borrar el archivo adjunto
    function borrarArchivoAdjunto() {
        if (!loteActual) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se ha seleccionado ningún lote.'
            });
            return;
        }

        loteActual.archivo = null;
        document.getElementById('archivoAdjunto').style.display = 'none';
        document.getElementById('previsualizacionArchivo').style.display = 'none';
        document.getElementById('archivo').value = '';
        document.getElementById('botonBorrarArchivo').style.display = 'none';

        // Guardar en localStorage
        localStorage.setItem('lotesPorCalle', JSON.stringify(lotesPorCalle));

        Swal.fire({
            icon: 'success',
            title: 'Archivo Borrado',
            text: 'El archivo adjunto ha sido borrado.'
        });
    }

    // Manejar la previsualización de archivos
    function manejarPrevisualizacionArchivo(archivo) {
        if (!archivo) return;

        const previsualizacion = document.getElementById('previsualizacionArchivo');
        const archivoAdjunto = document.getElementById('archivoAdjunto');
        const enlaceArchivo = document.getElementById('enlaceArchivo');

        if (archivo.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previsualizacion.src = e.target.result;
                previsualizacion.style.display = 'block';
            };
            reader.readAsDataURL(archivo);
        } else {
            previsualizacion.style.display = 'none';
        }

        // Crear un objeto URL para el archivo
        const urlArchivo = URL.createObjectURL(archivo);
        enlaceArchivo.href = urlArchivo;
        enlaceArchivo.textContent = archivo.name;
        archivoAdjunto.style.display = 'block';
        document.getElementById('botonBorrarArchivo').style.display = 'inline-block';
    }

    // Función para manejar el clic en la zona de arrastrar y soltar
    function inicializarDragAndDrop() {
        const dropzone = document.getElementById('dropzone');
        const archivoInput = document.getElementById('archivo');

        dropzone.addEventListener('click', () => {
            archivoInput.click();
        });

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const archivos = e.dataTransfer.files;
            if (archivos.length > 0) {
                archivoInput.files = archivos;
                manejarPrevisualizacionArchivo(archivos[0]);
            }
        });

        archivoInput.addEventListener('change', function(event) {
            const archivo = event.target.files[0];
            if (archivo) {
                manejarPrevisualizacionArchivo(archivo);
            }
        });
    }

    // Función para seleccionar un lote al hacer doble clic
    document.querySelector('.mapa').addEventListener('dblclick', function(e) {
        let loteElem = null;
        if (e.target.classList.contains('lote')) {
            loteElem = e.target;
        } else if (e.target.parentElement.classList.contains('lote')) {
            loteElem = e.target.parentElement;
        }

        if (loteElem) {
            seleccionarLote(loteElem);
            mostrarFormularioDesdeMapa(loteElem.dataset, loteElem.dataset.calle);
        }
    });

    // Función para inicializar validaciones en el formulario
    function inicializarValidacionesFormulario() {
        const formulario = document.getElementById('formLote');
        const propietarioInput = document.getElementById('propietario');
        const estadoSelect = document.getElementById('estado');
        const enProcesoSelect = document.getElementById('enProceso');

        propietarioInput.addEventListener('input', function() {
            if (this.value.trim() === '') {
                this.setCustomValidity('Este campo es obligatorio.');
            } else {
                this.setCustomValidity('');
            }
        });

        estadoSelect.addEventListener('change', function() {
            if (this.value === '') {
                this.setCustomValidity('Este campo es obligatorio.');
            } else {
                this.setCustomValidity('');
            }

            // Mostrar u ocultar el subestado según el estado seleccionado
            if (this.value === 'en-proceso') {
                document.getElementById('subestado-container').style.display = 'block';
                document.getElementById('enProceso').required = true;
            } else {
                document.getElementById('subestado-container').style.display = 'none';
                document.getElementById('enProceso').value = '';
                document.getElementById('enProceso').required = false;
                document.getElementById('enProceso').setCustomValidity('');
            }
        });

        enProcesoSelect.addEventListener('change', function() {
            if (document.getElementById('estado').value === 'en-proceso' && this.value === '') {
                this.setCustomValidity('Este campo es obligatorio.');
            } else {
                this.setCustomValidity('');
            }
        });

        formulario.addEventListener('submit', guardarDatosLote);
    }

    // Función para mostrar popup informativo del lote al hacer doble clic
    function mostrarPopupLote(divLote) {
        const calle = divLote.dataset.calle;
        const lote = divLote.dataset.lote;
        const estado = divLote.dataset.estado;
        const subestado = divLote.dataset.subestado;

        let contenido = `
            <strong>Calle:</strong> ${calle}<br>
            <strong>Lote:</strong> ${lote}<br>
            <strong>Estado:</strong> ${estado.charAt(0).toUpperCase() + estado.slice(1)}
        `;

        if (estado === 'en-proceso' && subestado) {
            contenido += `<br><strong>Subestado:</strong> ${subestado.replace('-', ' ').charAt(0).toUpperCase() + subestado.replace('-', ' ').slice(1)}`;
        }

        // Obtener el lote actual para acceder a propietario e inquilino
        const calleObj = lotesPorCalle.find(c => c.numero == calle);
        if (calleObj) {
            let loteObj = calleObj.lotesIzquierdo.find(l => l.numero === lote);
            if (!loteObj) {
                loteObj = calleObj.lotesDerecho.find(l => l.numero === lote);
            }

            if (loteObj) {
                contenido += `<br><strong>Propietario:</strong> ${loteObj.propietario || 'N/A'}`;
                if (loteObj.inquilino && loteObj.inquilino.trim() !== '') {
                    contenido += `<br><strong>Inquilino:</strong> ${loteObj.inquilino}`;
                }
            }
        }

        if (divLote.archivo) {
            contenido += `<br><strong>Archivo:</strong> <a href="${divLote.archivo.url}" target="_blank">${divLote.archivo.nombre}</a>`;
        }

        Swal.fire({
            title: 'Información del Lote',
            html: contenido,
            icon: 'info',
            showCloseButton: true,
            focusConfirm: false,
            confirmButtonText: 'Cerrar'
        });
    }
</script>

</body>
</html>
